<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>New Note .. uglynotes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
    <link rel="stylesheet" href="/public/style-light.css?v11">
    <script src="/public/mithril.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@1.2.7/lib/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.2.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
    <script src="/public/util2.js?v1"></script>
  </head>
  <style>
    .NoteContents {
	background-color: #FFFBFB;
    }
  </style>
  <body>
<script>

  let Exists = false;
  let Note = {ID:'', Deleted:false, Patches:[], Tags:[], CreatedAt:'', UpdatedAt:''};
  let AutoSubmitID;
  let Stopped = true;
  
  const root = document.body;

  const Alerts = CreateAlerts(9);

  const AlertsForCopy = CreateAlerts();

  const [infoIcon, infoMsg] = InfoPair(
    'page', `注意：在修改了笔记或标签后，在离开本页面前(比如在点击浏览器的后退键前),
请点击一次 update 按钮，以确保修改内容被保存到服务器。另外要注意当错误提示“已停止自动保存”时
请按 F12 进入控制台执行 restartAutoSubmit() 即可重新启用自动保存功能。`);
 
  const TopBanner = {
    view: () =>  m('div', {id:'top-banner'}, [
      Exists ? 'Edit Note' : 'New Note',
      m(infoIcon),
      ' .. ',
      m('a', {href:'/converter', title:'image converter', target:'_blank'}, 'Converter'),
      !Exists ? '' : m('div', {id: 'head-buttons'}, [
	'|',
	m('a', {href:`/light/note?id=${Note.ID}`, target:'_blank'}, 'readonly-mode'), '|',
	m('a', {href:`/html/history?id=${Note.ID}&version=${Note.Patches.length}`, target:'_blank'}, 'History'),
	'|',
      ]),
    ])
  };

  const TypeSelector = {
    CurrentType: 'plaintext',
    OldType: 'plaintext',
    InPreview: false,
    view: function() {
      const self = TypeSelector;
      return m('p', {onchange:self.UpdateType}, [
	self.InPreview ? '' : [
	  m('input', {type:'radio', id:'plaintext', name:'note-type', value:'plaintext',
		      checked: self.CurrentType.toLowerCase() == 'plaintext' ? true : false}),
	  m('label', {for:'plaintext'}, 'plaintext'),
	  [' (',m('a', {id:'copy',class:'Pointer',"data-clipboard-target":'#contents'}, 'copy'),')'],
	],
	m('input', {type:'radio', id:'markdown', name:'note-type', value:'markdown',
		    checked: self.CurrentType.toLowerCase() == 'markdown' ? true : false}),
	m('label', {for:'markdown'}, 'markdown'),
	['(',
	 self.InPreview ? '' : m('a', {accesskey:'p', onclick:self.Preview,class:'Pointer'}, 'preview'),
	 self.InPreview ? m('a', {accesskey:'e', onclick:self.Edit,class:'Pointer'}, 'edit') : '',
	 ,')'],
	m(AlertsForCopy),
      ]);
    },
    UpdateType: function() {
      TypeSelector.CurrentType = $('input[name="note-type"]:checked').value;
    },
    Preview: function() {
      TypeSelector.InPreview = true;
      const contents = $('#contents').value.trim();
      const dirty = marked(contents);
      const clean = DOMPurify.sanitize(dirty);
      Preview.Html = clean;
    },
    Edit: function() {
      TypeSelector.InPreview = false;
    },
  };

  const Textarea = {
    Rows: '10',
    Contents: '',
    OldContents: '',
    view: function() {
      const self = Textarea;
      return [
	m('textarea', {id:'contents', accesskey:'c', onblur:self.UpdateContents, rows:self.Rows}, self.Contents),
	m('p',{class:'Pointer',title:'higher',style:'text-align:right;',onclick:self.Higher},m.trust(
	  `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-expand" viewBox="0 0 16 16">
	     <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
	   </svg>`
	)),
      ];
    },
    Higher: function() {
      Textarea.Rows = parseInt(Textarea.Rows) + 5;
      $('#contents').focus();
    },
    CurrentContents: function() { return $('#contents').value; },
    UpdateContents: function() {
      Textarea.Contents = Textarea.CurrentContents();
    },
  };

  const Preview = {
    Html: '',
    view: function() {
      return m('div', {id:'preview', class:'NoteContents'}, m.trust(Preview.Html));
    }
  };

  const Tags = {
    Tags: [],
    OldTags: [],
    view: () => m('p', [
      m('label', {for:'tags'}, 'Tags:'),
      m('textarea', {id:'tags', accesskey:'t', onblur:Tags.Onblur, rows:2}, addPrefix(Tags.Tags, '#')),
    ]),
    Onblur: function(event) {
      Tags.Tags = tagsStringToSet(event.currentTarget.value);
    },
  };

  const [aboutShortcutIcon, aboutShortcutMsg] = InfoPair(
    'shortcut', `本页有快捷键 Alt + Shift + 字母，其中字母可以是 p, e 或 c, 分别表示
      预览、编辑、文本框。(详情请看 Releases.md)`);

  const Submit = {
    Display: false,
    Value: 'submit',
    view: function() {
      const self = Submit;
      return m('p', [
	self.Value == 'submit' ? m('button', {onclick:self.Submit, disabled:self.Disabled}, self.Value) : '',
	self.Value == 'update' ? m('button', {onclick:self.Update, disabled:self.Disabled}, self.Value) : '',
	m(aboutShortcutIcon),
	m(aboutShortcutMsg),
      ]);
    },
    CheckContents: function(contents) {
      if (contents == '') {
        // 有 event 表示点击了按钮，这种情况要给用户提示。
        // 如果没有 event 则是后台自动运行，不需要提示。
        if (event) Alerts.Insert('info', '笔记内容不可空白');
        return 'NG';
      }
      if (contents.length > NoteSizeLimit) {
	Alerts.Insert('danger', '超过笔记体积上限: ' + fileSizeToString(NoteSizeLimit));
	return 'NG';
      }
      if (contents == Textarea.OldContents) {
	if (event) Alerts.Insert('info', '笔记内容没有变化');
	return 'NG';
      }
      return 'OK';
    },
    Submit: function(event) {
      event.preventDefault();
      const contents = Textarea.CurrentContents().trim();
      if (Submit.CheckContents(contents) == 'NG') return;
      if (Tags.Tags.size < 2) {
	Alerts.Insert('至少需要 2 个标签才能创建笔记');
	return;
      }

      const patch = Diff.createPatch(" ", "", contents);
      const body = new FormData();
      const note_type = TypeSelector.CurrentType;
      body.append('note-type', note_type);
      body.append('title', contents.substring(0, NoteTitleLimit));
      body.append('patch', patch);
      body.append('tags', JSON.stringify(Array.from(Tags.Tags)));

      mRequest({method:'POST', url:'/api/note', body:body},
	       Alerts, Submit, 'Disabled', resp => {
		 Note = resp;
		 TypeSelector.OldType = note_type;
		 Tags.OldTags = Tags.Tags;
		 Textarea.OldContents = Textarea.Contents;
		 App.EnterEditMode();
		 Alerts.Insert('success', '新笔记创建成功 id:' + Note.ID);
	       }, () => {
		 stopAutoSubmit();
	       });
    },
    Update: function(event) {
      event.preventDefault();

      // 更新笔记类型
      const note_type = TypeSelector.CurrentType;
      if (note_type != TypeSelector.OldType) {
	const body = new FormData();
	body.append('note-type', note_type);
	mRequest({method:'PUT-', url:`/api/note/${Note.ID}/type`, body:body},
		 Alerts, Submit, 'Disabled', () => {
		   TypeSelector.OldType = note_type;
		   Alerts.Insert('success', '笔记类型更新成功: ' + note_type);
		 }, () => {
		   stopAutoSubmit();
		 });
      }

      // 更新标签
      if (!setsAreEqual(Tags.Tags, Tags.OldTags)) {
	if (Tags.Tags.size < 2) {
	  Alerts.Insert('danger', '至少需要 2 个标签');
	  return;
	}
	const body = new FormData();
	body.append('tags', JSON.stringify(Array.from(Tags.Tags)));

	mRequest({method:'PUT', url:`/api/note/${Note.ID}/tags`, body:body},
		 Alerts, Submit, 'Disabled', () => {
		   Tags.OldTags = Tags.Tags;
		   Alerts.Insert('success', '标签更新成功: ' + addPrefix(Tags.Tags, '#'));
		 }, () => {
		   stopAutoSubmit();
		 });
      }

      // 更新笔记内容
      let contents = Textarea.CurrentContents().trim();
      if (Submit.CheckContents(contents) == 'NG') {
	return;
      }
      const patch = Diff.createPatch(" ", Textarea.OldContents, contents);
      const body = new FormData();
      body.append('title', contents.substring(0, NoteTitleLimit));
      body.append('patch', patch);

      mRequest({method:'PATCH', url:`/api/note/${Note.ID}`, body:body},
	Alerts, Submit, 'Disabled', () => {
	  Textarea.OldContents = Textarea.Contents;
	  Note.Patches.push(patch);
	  Alerts.Insert('success', `笔记内容更新，产生第 ${Note.Patches.length} 个历史版本`);
	}, () => {
	  stopAutoSubmit();
	});
    },
  };
  
  const EditForm = {
    Display: 'none',
    view: function() {
      return m('form', {autocomplete:false, style:{display:EditForm.Display}}, [
	m(TypeSelector),
	TypeSelector.InPreview ? '' : m(Textarea),
	TypeSelector.InPreview ? m(Preview) : '',
	m(Tags),
	m(Submit),
      ]);
    }
  };
  
  const App = {
    oninit: function() {
      if (document.location.pathname == '/light/note/edit') {
	const param_id = getUrlParam('id');
	mRequest(
	  {method:'GET', url:`/api/note/${param_id}`}, Alerts, null, null, resp => {
	    Note = resp;
	    if (Note.Deleted) {
	      Alerts.Insert('danger', `the note(id:${param_id}) is deleted`);
	      return;
	    }
	    App.EnterEditMode();
	    TypeSelector.CurrentType = Note.Type;
	    TypeSelector.OldType = Note.Type;
	    Textarea.Contents = Note.Patches.reduce(
	      (patched, patch) => Diff.applyPatch(patched, patch), "");
	    Textarea.OldContents = Textarea.Contents;
	    const tagNames = toTagNames(Note.Tags);
	    Tags.Tags = new Set(tagNames);
	    Tags.OldTags = Tags.Tags;
	    Alerts.Insert('success', '已获取笔记 id: ' + Note.ID);
	    Alerts.Insert('success', '已进入编辑模式');
	    window.setTimeout(() => {$('#contents').focus()}, 500);
	  },
	  () => { stopAutoSubmit(); },
	  () => { Loading.Hide(); });
      }
      if (document.location.pathname == '/light/note/new') {
	const param_tags = getUrlParam('tags');
	if (param_tags) {
	  Tags.Tags = tagsStringToSet(param_tags);
	}
	Loading.Hide();
	EditForm.Display = 'block';
	window.setTimeout(() => {$('#contents').focus()}, 500);
      }
    },
    view: () => [
      m(TopBanner),
      m(infoMsg),
      Spacer,
      m(Loading),
      m(EditForm),
      m(Alerts),
      BottomLine,
    ],
    EnterEditMode: function() {
      Exists = true;
      EditForm.Display = 'block';
      Submit.Value = 'update';
      $('title').text = 'Edit Note .. uglynotes';
    }
  };

  m.mount(root, App);

  const clipboard = new ClipboardJS('#copy', {
    text: () => { return Textarea.Contents; }
  });
  clipboard.on('success', () => {
    AlertsForCopy.Insert('success', '笔记内容已复制到剪贴板');
    m.redraw();
  });
  clipboard.on('error', e => {
    console.error('Action:', e.action);
    console.error('Trigger:', e.trigger);
    AlertsForCopy.Insert('danger', '复制失败，详细信息见控制台');
    m.redraw();
  });

  function submit_or_update() {
    if (Exists) { Submit.Submit(); } else { Submit.Update(); }
  }

  function restartAutoSubmit() {
    if (!Stopped) stopAutoSubmit();
    AutoSubmitID = window.setInterval(submit_or_update, DelayOfAutoUpdate);
    Stopped = false;
    const msg = '启用自动保存功能: OK';
    console.log(msg);
    Alerts.Insert('success', msg);
    AlertsForCopy.Clear();
    infoMsg.Display = 'none';
    m.redraw();
  }
  restartAutoSubmit();

  function stopAutoSubmit() {
    window.clearInterval(AutoSubmitID);
    Stopped = true;
    const msg = '已停止自动保存，请手动执行 restartAutoSubmit()';
    Alerts.Insert('danger', msg);
    AlertsForCopy.Insert('danger', msg);
    infoMsg.Display = 'block';
  }
  
</script>
  </body>
  </html>
