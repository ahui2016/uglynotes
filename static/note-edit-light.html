<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>New Note .. uglynotes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
    <link rel="stylesheet" href="/public/style-light.css?v11">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@1.2.7/lib/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.2.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
    <script src="/public/util2.js?v1"></script>
    <script src="/public/components.js?v11"></script>
  </head>
  <style>
    .NoteContents {
	background-color: #FFFBFB;
    }
  </style>
  <body>
    <div id="root"></div>
<script>

  let AutoSubmitID;
  let Stopped = true;
  
  const root = document.body;

  const Alerts = CreateAlerts(9);

  const AlertsForCopy = CreateAlerts();

  const [infoIcon, infoMsg] = InfoPair(
    'page', `注意：在修改了笔记或标签后，在离开本页面前(比如在点击浏览器的后退键前),
请点击一次 update 按钮，以确保修改内容被保存到服务器。另外要注意当错误提示“已停止自动保存”时
请按 F12 进入控制台执行 restartAutoSubmit() 即可重新启用自动保存功能。`);

  const PageTitle = cc('span');
  const HeadButtons = cc('span', 'head-buttons');
  const ReadonlyMode = cc('a');
  const History = cc('a');
  const TopBanner = {
    view: () =>  m('div').append([
      m(PageTitle).text('New Note'),
      m(infoIcon),
      ' .. ',
      $('<a href="/converter" title="image converter" target="_blank">Converter</a>');
      m(HeadButtons).css('display', 'none').append([
	'|',
	m(ReadonlyMode).text('readonly-mode').attr('target', '_blank'), '|',
	m(History).text('History').attr('target', '_blank'),
	'|',
      ]),
    ]),
  };

  const PlaintextBtnArea = cc('span');
  const MarkdownBtn = cc('input');
  const PreviewBtn = cc('a');
  const EditBtn = cc('a');
  const TypeSelector = {
    oldType: 'plaintext',
    currentType: () => $('input[name="note-type"]:checked').value,
    view: () => {
      const self = TypeSelector;
      return m('p').append([
	m(PlaintextBtnArea).append([
	  $('<input type="radio" id="plaintext" name="note-type" value="plaintext" checked>'),
	  m('label').text('plaintext').attr('for', 'plaintext'),
	  ' (',
	  $('<a id="copy" class="Pointer" data-clipboard-target="#contents">copy</a>'),
	  ')'],
	],
	$(MarkdownBtn).attr({type:'radio',name:'note-type',value:'markdown'}),
	m('label').text('markdown').attr('for', 'markdown'),
	'(',
	m(PreviewBtn).attr({text:'preview',accesskey:'p',class:'Pointer'}).click(self.Preview),
	m(EditBtn).attr({text:'edit',accesskey:'e',class:'Pointer',style:'display:none'}).click(self.Edit),
	')',
	m(AlertsForCopy),
      ]);
    },
    Preview: function(event) {
      const contents = $('#contents').value.trim();
      const dirty = marked(contents);
      const clean = DOMPurify.sanitize(dirty);
      $(Preview.id).show().html(clean);
      $(Textarea.id).hide();
      $(PreviewBtn.id).hide();
      $(EditBtn.id).show();
      $(PlaintextBtnArea.id).hide();
    },
    Edit: function() {
      $(Preview.id).hide();
      $(Textarea.id).show();
      $(PreviewBtn.id).show();
      $(EditBtn.id).hide();
      $(PlaintextBtnArea.id).show();
    },
  };

  const Contents = cc('textarea', 'contents');
  const Higher = cc('p');
  const Textarea = {
    id: '#textarea',
    currentContents: '',
    oldContents: '',
    view: function() {
      const self = Textarea;
      return m('div').attr('id', 'textarea').append([
	m(Contents).attr({accesskey:'c',rows:'10'}).blur(self.updateContents),
	m(Higher).attr({class:'Pointer',title:'higher',style:'text-align:right;'}).click(self.higher).html(
	  `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-expand" viewBox="0 0 16 16">
	     <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
	   </svg>`
	),
      ]);
    },
    updateContents: (event) => {
      Textarea.currentContents = event.currentTarget.value;
    },
    checkContents: () => {
      const self = Textarea;
      if (self.currentContents == '') {
        // 有 event 表示点击了按钮，这种情况要给用户提示。
        // 如果没有 event 则是后台自动运行，不需要提示。
        if (event) Alerts.Insert('info', '笔记内容不可空白');
        return 'NG';
      }
      if (self.currentContents.length > NoteSizeLimit) {
	Alerts.Insert('danger', '超过笔记体积上限: ' + fileSizeToString(NoteSizeLimit));
	return 'NG';
      }
      if (self.currentContents == self.oldContents) {
	if (event) Alerts.Insert('info', '笔记内容没有变化');
	return 'NG';
      }
      return 'OK';
    },
    higher: function() {
      const rows = parseInt($(Textarea.id).attr('rows'));
      $(Textarea.id).attr('rows', rows + 5);
      $(Contents.id).focus();
    },
  };

  const Preview = {
    id: '#preview',
    view: () => m('div').attr({id:'preview',class:'NoteContents'}),
  };

  const Tags = {
    currentTags: [],
    oldTags: [],
    view: () => m('p').append([
      m('label').attr({for:'tags',text:'Tags:'}),
      m('textarea').attr({accesskey:'t',rows:'2'}).blur(Tags.onblur),
    ]),
    onblur: function(event) {
      Tags.currentTags = tagsStringToSet(event.currentTarget.value);
      event.currentTarget.value = Tags.currentTags;
    },
  };

  const [aboutShortcutIcon, aboutShortcutMsg] = InfoPair(
    'shortcut', `本页有快捷键 Alt + Shift + 字母，其中字母可以是 p, e 或 c, 分别表示
      预览、编辑、文本框。(详情请看 Releases.md)`);

  const SubmitBtn = cc('button');
  const UpdateBtn = cc('button');
  const Submit = {
    view: function() {
      const self = Submit;
      return m('p').append([
	m(SubmitBtn).val('submit').click(self.submit),
	m(UpdateBtn).val('update').click(self.update),
	m(aboutShortcutIcon),
	m(aboutShortcutMsg),
      ]);
    },
    Submit: function(event) {
      event.preventDefault();
      if (Textarea.checkContents(contents) == 'NG') return;
      if (Tags.currentTags.size < 2) {
	Alerts.Insert('至少需要 2 个标签才能创建笔记');
	return;
      }

      const contents = Textarea.currentContents.trim();
      const patch = Diff.createPatch(" ", "", contents);
      const note_type = TypeSelector.currentType();
      const body = new FormData();
      body.append('note-type', note_type);
      body.append('title', contents.substring(0, NoteTitleLimit));
      body.append('patch', patch);
      body.append('tags', JSON.stringify(Array.from(Tags.currentTags)));

      mRequest({method:'POST', url:'/api/note', body:body},
	       Alerts, Submit, 'Disabled', resp => {
		 Note = resp;
		 TypeSelector.OldType = note_type;
		 Tags.OldTags = Tags.Tags;
		 Textarea.OldContents = Textarea.Contents;
		 App.EnterEditMode();
		 Alerts.Insert('success', '新笔记创建成功 id:' + Note.ID);
	       }, () => {
		 stopAutoSubmit();
	       });
    },
    Update: function(event) {
      event.preventDefault();

      // 更新笔记类型
      const note_type = TypeSelector.CurrentType;
      if (note_type != TypeSelector.OldType) {
	const body = new FormData();
	body.append('note-type', note_type);
	mRequest({method:'PUT-', url:`/api/note/${Note.ID}/type`, body:body},
		 Alerts, Submit, 'Disabled', () => {
		   TypeSelector.OldType = note_type;
		   Alerts.Insert('success', '笔记类型更新成功: ' + note_type);
		 }, () => {
		   stopAutoSubmit();
		 });
      }

      // 更新标签
      if (!setsAreEqual(Tags.Tags, Tags.OldTags)) {
	if (Tags.Tags.size < 2) {
	  Alerts.Insert('danger', '至少需要 2 个标签');
	  return;
	}
	const body = new FormData();
	body.append('tags', JSON.stringify(Array.from(Tags.Tags)));

	mRequest({method:'PUT', url:`/api/note/${Note.ID}/tags`, body:body},
		 Alerts, Submit, 'Disabled', () => {
		   Tags.OldTags = Tags.Tags;
		   Alerts.Insert('success', '标签更新成功: ' + addPrefix(Tags.Tags, '#'));
		 }, () => {
		   stopAutoSubmit();
		 });
      }

      // 更新笔记内容
      let contents = Textarea.CurrentContents().trim();
      if (Submit.CheckContents(contents) == 'NG') {
	return;
      }
      const patch = Diff.createPatch(" ", Textarea.OldContents, contents);
      const body = new FormData();
      body.append('title', contents.substring(0, NoteTitleLimit));
      body.append('patch', patch);

      mRequest({method:'PATCH', url:`/api/note/${Note.ID}`, body:body},
	Alerts, Submit, 'Disabled', () => {
	  Textarea.OldContents = Textarea.Contents;
	  Note.Patches.push(patch);
	  Alerts.Insert('success', `笔记内容更新，产生第 ${Note.Patches.length} 个历史版本`);
	}, () => {
	  stopAutoSubmit();
	});
    },
  };
  
  const EditForm = {
    Display: 'none',
    view: function() {
      return m('form', {autocomplete:false, style:{display:EditForm.Display}}, [
	m(TypeSelector),
	TypeSelector.InPreview ? '' : m(Textarea),
	TypeSelector.InPreview ? m(Preview) : '',
	m(Tags),
	m(Submit),
      ]);
    }
  };
  
  const App = {
    oninit: function() {
      if (document.location.pathname == '/light/note/edit') {
	const param_id = getUrlParam('id');
	mRequest(
	  {method:'GET', url:`/api/note/${param_id}`}, Alerts, null, null, resp => {
	    Note = resp;
	    if (Note.Deleted) {
	      Alerts.Insert('danger', `the note(id:${param_id}) is deleted`);
	      return;
	    }
	    App.EnterEditMode();
	    TypeSelector.CurrentType = Note.Type;
	    TypeSelector.OldType = Note.Type;
	    Textarea.Contents = Note.Patches.reduce(
	      (patched, patch) => Diff.applyPatch(patched, patch), "");
	    Textarea.OldContents = Textarea.Contents;
	    const tagNames = toTagNames(Note.Tags);
	    Tags.Tags = new Set(tagNames);
	    Tags.OldTags = Tags.Tags;
	    Alerts.Insert('success', '已获取笔记 id: ' + Note.ID);
	    Alerts.Insert('success', '已进入编辑模式');
	    window.setTimeout(() => {$('#contents').focus()}, 500);
	  },
	  () => { stopAutoSubmit(); },
	  () => { Loading.Hide(); });
      }
      if (document.location.pathname == '/light/note/new') {
	const param_tags = getUrlParam('tags');
	if (param_tags) {
	  Tags.Tags = tagsStringToSet(param_tags);
	}
	Loading.Hide();
	EditForm.Display = 'block';
	window.setTimeout(() => {$('#contents').focus()}, 500);
      }
    },
    view: () => [
      m(TopBanner),
      m(infoMsg),
      Spacer,
      m(Loading),
      m(EditForm),
      m(Alerts),
      BottomLine,
    ],
    EnterEditMode: function() {
      Exists = true;
      EditForm.Display = 'block';
      Submit.Value = 'update';
      $('title').text = 'Edit Note .. uglynotes';
    }
  };

  m.mount(root, App);

  const clipboard = new ClipboardJS('#copy', {
    text: () => { return Textarea.Contents; }
  });
  clipboard.on('success', () => {
    AlertsForCopy.Insert('success', '笔记内容已复制到剪贴板');
    m.redraw();
  });
  clipboard.on('error', e => {
    console.error('Action:', e.action);
    console.error('Trigger:', e.trigger);
    AlertsForCopy.Insert('danger', '复制失败，详细信息见控制台');
    m.redraw();
  });

  function submit_or_update() {
    if (Exists) { Submit.Submit(); } else { Submit.Update(); }
  }

  function restartAutoSubmit() {
    if (!Stopped) stopAutoSubmit();
    AutoSubmitID = window.setInterval(submit_or_update, DelayOfAutoUpdate);
    Stopped = false;
    const msg = '启用自动保存功能: OK';
    console.log(msg);
    Alerts.Insert('success', msg);
    AlertsForCopy.Clear();
    infoMsg.Display = 'none';
    m.redraw();
  }
  restartAutoSubmit();

  function stopAutoSubmit() {
    window.clearInterval(AutoSubmitID);
    Stopped = true;
    const msg = '已停止自动保存，请手动执行 restartAutoSubmit()';
    Alerts.Insert('danger', msg);
    AlertsForCopy.Insert('danger', msg);
    infoMsg.Display = 'block';
  }
  
</script>
  </body>
  </html>
