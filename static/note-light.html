<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Note .. uglynotes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
    <link rel="stylesheet" href="/public/style-light.css?v11">
    <script src="/public/mithril.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@1.2.7/lib/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.2.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
    <script src="/public/util2.js?v1"></script>
  </head>
  <style>
    #info-block {
	color: #999;
	font-size: smaller;
    }
  </style>
  <body>
<script>

  let Exists = false;
  let NoteID = '';
  let Note = {Size:'',Deleted:false,Contents:'',Tags:[],CreatedAt:'',UpdatedAt:'',DelOptions:{method:'',url:''}};

  const bodyForDel = new FormData();
  bodyForDel.append('deleted', true);
  
  const root = document.body;

  const Alerts = CreateAlerts();

  const TopBanner = {
    Config: {
      DelBtn: 'inline',
      DelDisabled: false,
      DelBtnText: 'Delete',
      ConfirmBlock: 'none',
      ConfirmMsg: 'delete this note?',
      DelResult: `该笔记已删除`,
      UndelBlock: 'none',
      UndelBtn: 'inline',
      UndelDisabled: false,
      UndelConfirmBlock: 'none',
    },
    view: function() {
      const self = TopBanner;
      const cfg = TopBanner.Config;
      return m('div', {id:'top-banner'}, [
	`Note [id:${NoteID}]`,
	!Exists ? '' : m('div', {id: 'head-buttons'}, [
	  '|',
	  [m('a', {id:'copy'}, 'Copy'), '|'],
	  Note.Deleted ? '' : m('span', [
	    m('a', {href:'/html/note/edit?id=' + NoteID}, 'Edit'), '|'
	  ]),
	  [m('a', {href:'/html/history?id=' + NoteID}, 'History'), '|'],
	  [
	    m('a', {onclick:self.ShowDelete, style:{display:cfg.DelBtn}}, cfg.DelBtnText),
	    m('span', {style:{display:cfg.ConfirmBlock}}, [
	      m('span', {class:'ConfirmDelete'}, cfg.ConfirmMsg),
	      m('button', {class:'SlimButton', onclick:self.DoDelete}, 'yes'),
	      m('button', {class:'SlimButton', onclick:self.CancelDelete}, 'no'),
	    ]),
	    '|',
	  ],
	  m('span', {style:{display:cfg.UndelBlock}}, [
	    m('a', {onclick:self.ShowUndelete, style:{display:cfg.UndelBtn}}, 'Undelete'),
	    m('span', {style:{display:cfg.UndelConfirmBlock}}, [
	      m('span', {style:'margin-left:5px;'}, 'undelete this note?'),
	      m('button', {class:'SlimButton', onclick:self.DoUndelete}, 'yes'),
	      m('button', {class:'SlimButton', onclick:self.CancelUndelete}, 'no'),
	    ]),
	    '|',
	  ]), // end of undelete block
	]), // end of head buttons
      ]); // end of top banner
    }, // end of view
    ShowDelete: function() {
      TopBanner.Config.DelBtn = 'none';
      TopBanner.Config.ConfirmBlock = 'inline';
    },
    CancelDelete: function() {
      TopBanner.Config.DelBtn = 'inline';
      TopBanner.Config.ConfirmBlock = 'none';
    },
    DoDelete: function() {
      const cfg = TopBanner.Config;
      mRequest(Note.DelOptions, Alerts, cfg, 'DelDisabled', () => {
	  Exists = false;
	  Alerts.Insert('success', cfg.DelResult);
      });
    },
    ShowUndelete: function() {
      TopBanner.Config.UndelBtn = 'none';
      TopBanner.Config.UndelConfirmBlock = 'inline';
    },
    CancelUndelete: function() {
      TopBanner.Config.UndelBtn = 'inline';
      TopBanner.Config.UndelConfirmBlock = 'none';
    },
    DoUndelete: function() {
      const cfg = TopBanner.Config;
      const body = new FormData();
      body.append('deleted', false);
      mRequest(
	{method:'PUT', url:`/api/note/${NoteID}/deleted`, body:body},
	Alerts, cfg, 'UndelDisabled', () => {
	  Note.DelOptions = {method:'PUT',url:`/api/note/${NoteID}/deleted`,body:bodyForDel};
	  cfg.DelResult = `该笔记已删除`;
	  cfg.EditBtnBlock = 'inline';
	  cfg.ConfirmMsg = 'delete this note?';
	  cfg.UndelBlock = 'none';
	  Alerts.Insert('success', '该笔记已复原，可正常编辑');
	});
    },
  };

  const InfoBlock = {
    view: () => m('div', {id:'title-block'}, [
      m('p', {id:'info-block'}, [
	`Created at: ${Note.CreatedAt}`, m('br'),
	`Updated at: ${Note.UpdatedAt}`, m('br'),
	`Type: ${Note.Type} (size: ${Note.Size})`, 
      ]),
      m('p', [
	'Tags:',
	Note.Tags.map(tag => m('a', {class:'Tag', href:'/html/search?tags='+encodeURIComponent(tag.Name)}, tag.Name)),
	m('a', {class:'Tag TagButton', title:'search tag group', href:'/html/search?tags='+Note.TagGroup}, 'group'),
      ]),
    ]),
  };

  const Contents = {
    view: function() {
      if (Note.Type == 'Markdown') {
	const dirty = marked(Note.Contents);
	const clean = DOMPurify.sanitize(dirty);
	return m('div', {class:'NoteContents'}, m.trust(clean));
      } else {
	return m('pre', {class:'NoteContents'}, Note.Contents);
      }
    }
  };

  const App = {
    oninit: function() {
      const cfg = TopBanner.Config;
      NoteID = getUrlParam('id');
      m.request({method:'GET', url:'/api/note/' + NoteID})
	.then(resp => {
	  Exists = true;
	  Note = resp;
	  Note.Contents = Note.Patches.reduce(
	    (patched, patch) => Diff.applyPatch(patched, patch), "");
	  Note.CreatedAt = dayjs(Note.CreatedAt).format('YYYY-MM-DD HH:mm:ss');
	  Note.UpdatedAt = dayjs(Note.UpdatedAt).format('YYYY-MM-DD HH:mm:ss');
	  Note.Size = fileSizeToString(Note.Size);
	  Note.TagGroup = encodeURIComponent(addPrefix(toTagNames(Note.Tags)));
	  Note.DelOptions = {method:'PUT',url:`/api/note/${NoteID}/deleted`,body:bodyForDel};
	  if (Note.Deleted) {
	    Note.DelOptions = {method:'DELETE', url:`/api/note/${NoteID}`};
	    cfg.EditBtnBlock = 'none';
	    cfg.ConfirmMsg = 'delete this note permanently?';
	    cfg.DelResult = `该笔记已彻底删除`;
	    cfg.UndelBlock = 'inline';
	    Alerts.Insert('info', '该笔记被标记为 “已删除”');
	  }
	})
      	.catch(e => { Alerts.InsertRespErr(e); })
	.finally(() => { Loading.Hide(); });
    },
    view: () => [
      m(TopBanner),
      Spacer,
      m(Alerts),
      Exists ? m(InfoBlock) : '',
      m(Loading),
      Exists ? m(Contents) : '',
      BottomLine,
    ]
  };

  m.mount(root, App);

  const clipboard = new ClipboardJS('#copy', {
    text: () => { return Note.Contents; }
  });
  clipboard.on('success', () => {
    Alerts.Insert('success', '笔记内容已复制到剪贴板');
    m.redraw();
  });
  clipboard.on('error', e => {
    console.error('Action:', e.action);
    console.error('Trigger:', e.trigger);
    Alerts.Insert('danger', '复制失败，详细信息见控制台');
    m.redraw();
  });

</script>
</body>
</html>
